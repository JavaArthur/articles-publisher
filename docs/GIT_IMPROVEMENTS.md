# Git操作改进说明

## 🔧 主要改进

### 1. 增强的Git操作流程
- **提交前自动拉取**: 每次提交前先执行 `git pull` 避免冲突
- **冲突自动处理**: 检测到冲突时自动使用 `git stash` 策略
- **详细状态检查**: 显示工作区状态和待提交文件
- **智能提交检查**: 检查是否有实际需要提交的更改

### 2. 详细的日志输出
- **步骤级日志**: 每个Git操作步骤都有明确的状态提示
- **错误详情**: 显示具体的错误信息而不是隐藏输出
- **操作结果**: 显示每个命令的执行结果
- **故障排除**: 提供常见问题的解决建议

### 3. 路径问题解决
- **脚本目录定位**: 确保从任何位置执行脚本都能正确工作
- **工作目录切换**: 明确显示当前工作目录
- **相对路径处理**: 正确处理配置文件和相对路径

### 4. 错误处理增强
- **分步错误捕获**: 每个Git操作单独处理错误
- **智能重试**: 对于网络相关错误提供重试机制
- **用户友好提示**: 提供具体的解决方案而不是通用错误

## 🛠️ 新增工具

### Git测试脚本 (`test-git.sh`)
用于诊断Git相关问题的专用脚本：

```bash
./test-git.sh
```

功能：
- 检查Git仓库状态
- 测试网络连接
- 验证推送权限
- 显示工作区状态
- 检查分支信息

## 📋 改进的操作流程

### 之前的流程
```
git add . → git commit → git push
```

### 现在的流程
```
1. 检查Git仓库状态
2. 拉取最新代码 (git pull)
3. 处理可能的冲突
4. 添加文件 (git add .)
5. 检查待提交文件
6. 提交更改 (git commit)
7. 推送到远程 (git push)
```

## 🔍 日志示例

### 成功执行日志
```
🔄 切换到Git仓库目录...
🔍 检查Git仓库状态...
📋 发现未提交的更改:
   M source/_posts/example.md
⬇️  拉取最新代码...
✅ 代码拉取完成
➕ 添加文件到Git...
✅ 文件添加完成
📝 准备提交的文件:
   source/_posts/example.md
💾 提交更改...
✅ 提交完成
⬆️  推送到远程仓库...
✅ 推送完成
📤 Git提交和推送完成
```

### 错误处理日志
```
❌ Git操作失败，请手动处理
   详细错误: 推送被拒绝，远程仓库有新提交

💡 常见解决方案:
   1. 检查网络连接
   2. 确认Git仓库配置正确
   3. 检查是否有权限问题
   4. 手动执行: cd /path/to/repo && git status
```

## 🚀 使用建议

1. **首次使用前运行测试**:
   ```bash
   ./test-git.sh
   ```

2. **遇到问题时查看日志**:
   ```bash
   cat publish-$(date +%Y-%m-%d).log
   ```

3. **手动解决冲突后重新运行**:
   ```bash
   ./publish.sh "文章名.md"
   ```

## 🔧 故障排除

### 常见问题及解决方案

1. **推送被拒绝**
   - 原因: 远程仓库有新提交
   - 解决: 脚本会自动拉取并尝试合并

2. **认证失败**
   - 原因: Git认证配置问题
   - 解决: 检查SSH密钥或Personal Access Token

3. **网络超时**
   - 原因: 网络连接问题
   - 解决: 检查网络连接，稍后重试

4. **工作区有未提交更改**
   - 原因: 有本地修改未提交
   - 解决: 脚本会自动处理或提示手动解决

## 📝 配置检查

确保 `config.json` 中的Git配置正确：

```json
{
  "git": {
    "autoCommit": true,
    "autoPush": true,
    "commitPrefix": "📝 Blog:",
    "branch": "main"
  },
  "hexo": {
    "gitRepo": "/path/to/your/blog/repo"
  }
}
```

## 🎯 下一步优化

- [ ] 添加Git hooks支持
- [ ] 实现更智能的冲突解决
- [ ] 添加多分支支持
- [ ] 集成CI/CD状态检查
