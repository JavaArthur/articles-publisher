#!/usr/bin/env node

/**
 * Magic Publish - å…¨å±€CLIå‘½ä»¤
 * ç”¨æ³•: magic-publish <æ–‡ç« è·¯å¾„>
 */

const path = require('path');
const fs = require('fs');

// è·å–è„šæœ¬æ‰€åœ¨ç›®å½•ï¼Œæ¨å¯¼å‡ºé¡¹ç›®æ ¹ç›®å½•
const scriptDir = __dirname;
const projectRoot = path.dirname(scriptDir);
const magicPublishPath = path.join(projectRoot, 'src', 'core', 'magic-publish.js');

// æ£€æŸ¥é¡¹ç›®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (!fs.existsSync(magicPublishPath)) {
  console.error('âŒ é”™è¯¯: æ‰¾ä¸åˆ°magic-publish.jsæ–‡ä»¶');
  console.error(`   é¢„æœŸä½ç½®: ${magicPublishPath}`);
  console.error('   è¯·ç¡®ä¿åœ¨æ­£ç¡®çš„é¡¹ç›®ç›®å½•ä¸­å®‰è£…æ­¤å‘½ä»¤');
  process.exit(1);
}

// æ£€æŸ¥é…ç½®æ–‡ä»¶
const configPath = path.join(projectRoot, 'config.json');
if (!fs.existsSync(configPath)) {
  console.error('âŒ é”™è¯¯: æ‰¾ä¸åˆ°config.jsoné…ç½®æ–‡ä»¶');
  console.error(`   é¢„æœŸä½ç½®: ${configPath}`);
  console.error('   è¯·å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶');
  process.exit(1);
}

// æ£€æŸ¥å‚æ•°
const args = process.argv.slice(2);
if (args.length === 0) {
  console.log('ğŸ¯ Magic Publish - ä¸€é”®å‘å¸ƒå·¥å…·');
  console.log('');
  console.log('ç”¨æ³•:');
  console.log('  magic-publish <æ–‡ç« è·¯å¾„>');
  console.log('');
  console.log('ç¤ºä¾‹:');
  console.log('  magic-publish ~/Documents/æˆ‘çš„æ–‡ç« .md');
  console.log('  magic-publish ./æ–‡ç« .md');
  console.log('  magic-publish "/path/to/article.md"');
  console.log('');
  console.log('åŠŸèƒ½:');
  console.log('  â€¢ è‡ªåŠ¨ä¸‹è½½å¤–éƒ¨å›¾ç‰‡åˆ°æœ¬åœ°');
  console.log('  â€¢ è½¬æ¢å›¾ç‰‡é“¾æ¥ä¸ºæœ¬åœ°è·¯å¾„');
  console.log('  â€¢ ä¿å­˜åˆ°Hexoåšå®¢ç›®å½•');
  console.log('  â€¢ è‡ªåŠ¨Gitæäº¤å’Œæ¨é€');
  console.log('  â€¢ è‡ªåŠ¨Hexoç”Ÿæˆå’Œéƒ¨ç½²');
  console.log('');
  console.log('é…ç½®æ–‡ä»¶: ' + configPath);
  process.exit(0);
}

const inputPath = args[0];

// è®°å½•å½“å‰å·¥ä½œç›®å½•ï¼Œç”¨äºè·¯å¾„è§£æ
const currentWorkDir = process.cwd();

// å°†ç›¸å¯¹è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼ˆåŸºäºå½“å‰å·¥ä½œç›®å½•ï¼‰
const articlePath = path.resolve(currentWorkDir, inputPath);

// æ£€æŸ¥æ–‡ç« æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (!fs.existsSync(articlePath)) {
  console.error(`âŒ é”™è¯¯: æ–‡ç« æ–‡ä»¶ä¸å­˜åœ¨: ${articlePath}`);
  console.error(`   è¾“å…¥è·¯å¾„: ${inputPath}`);
  console.error(`   å·¥ä½œç›®å½•: ${currentWorkDir}`);
  process.exit(1);
}

// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è¯»
try {
  fs.accessSync(articlePath, fs.constants.R_OK);
} catch (error) {
  console.error(`âŒ é”™è¯¯: æ–‡ç« æ–‡ä»¶æ— æ³•è¯»å–: ${articlePath}`);
  console.error(`   è¯¦ç»†é”™è¯¯: ${error.message}`);
  process.exit(1);
}

// æ˜¾ç¤ºå½“å‰å·¥ä½œä¿¡æ¯
console.log('ğŸ¯ Magic Publish å¯åŠ¨ä¸­...');
console.log(`ğŸ“„ è¾“å…¥è·¯å¾„: ${inputPath}`);
console.log(`ğŸ“„ æ–‡ç« è·¯å¾„: ${articlePath}`);
console.log(`ğŸ“ å½“å‰ç›®å½•: ${currentWorkDir}`);
console.log(`ğŸ“ é¡¹ç›®è·¯å¾„: ${projectRoot}`);
console.log(`âš™ï¸  é…ç½®æ–‡ä»¶: ${configPath}`);
console.log('----------------------------------------');

// åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
process.chdir(projectRoot);

// è®¾ç½®æ–‡ç« è·¯å¾„å‚æ•°ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
process.argv[2] = articlePath;

// åŠ¨æ€åŠ è½½å¹¶æ‰§è¡Œ magic-publish.js
try {
  const MagicPublisher = require(magicPublishPath);
  
  // åˆ›å»ºå‘å¸ƒå™¨å®ä¾‹å¹¶æ‰§è¡Œå‘å¸ƒ
  const publisher = new MagicPublisher();
  publisher.publish().then(() => {
    // å‘å¸ƒæˆåŠŸ
    process.exit(0);
  }).catch((error) => {
    console.error('âŒ å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:');
    console.error(error.message);
    process.exit(1);
  });
} catch (error) {
  console.error('âŒ å‘å¸ƒå™¨åˆå§‹åŒ–å¤±è´¥:');
  console.error(error.message);
  process.exit(1);
}